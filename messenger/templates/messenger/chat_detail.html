{% extends 'messenger/base.html' %}

{% block content %}
<style>
    body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
    }

    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        position: relative;
        min-width: 300px;
        box-sizing: border-box; /* Добавляем box-sizing */
    }

    /* Добавляем медиа-запрос для мобильных устройств */
    @media screen and (max-width: 768px) {
        
        .chat-container {
            padding: 10px;
            margin: 0;
            width: 100%;
            max-width: 100%;
        }

        .messages-container {
            margin-bottom: 80px;
        }

        .message-input-container {
            width: 100%;
            border-radius: 0;
            padding: 15px;
        }

        .message-input {
            height: 45px;
            font-size: 16px;
            padding: 12px 15px;
        }

        .send-btn {
            padding: 12px 25px;
            font-size: 16px;
        }

        #replyContainer {
            width: 100%;
            left: 0;
            transform: none;
            padding: 0;
        }
    }

    .chat-header {
        background: white;
        padding: 10px 15px;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        display: flex;
        justify-content: space-between;
    }

    .chat-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
    }

    .messages-container {
        flex-grow: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse;
        padding: 10px;
        margin-bottom: 80px;
    }

    /* Скрываем полосу прокрутки для Chrome, Safari и Opera */
    .messages-container::-webkit-scrollbar {
        display: none;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s ease;
    }

    .message.sent {
        align-items: flex-end;
    }

    .message.received {
        align-items: flex-start;
    }

    .message-content {
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow: hidden;
        width: 100%;
    }

    .message-text {
        white-space: pre-wrap;
        word-break: break-word;
    }

    .sent .message-content {
        background: #0084ff;
        color: white;
    }

    .received .message-content {
        background: #e9ecef;
        color: black;
    }

    .message-time {
        font-size: 0.8em;
        color: #666;
        margin-top: 5px;
    }

    .message-form {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .file-input-container {
        position: relative;
        display: flex;
        align-items: center;
        order: 2;
    }

    .file-input {
        display: none;
    }

    .file-label {
        cursor: pointer;
        padding: 10px;
        color: #0084ff;
        font-size: 1.2em;
    }

    .file-label:hover {
        color: #0056b3;
        transition: color 0.2s ease;
    }

    .attached-file-name {
        font-size: 0.8em;
        color: #666;
        margin-left: 10px;
    }

    /* Стили для отображения прикрепленных файлов в сообщениях */
    .message-attachment {
        margin-top: 5px;
        max-width: 100%;
    }

    .message-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
        display: block;
    }

    .message-image:hover {
        transform: scale(1.05);
    }

    /* Стили для модального окна с полноразмерным изображением */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        cursor: pointer;
    }

    .modal-content {
        max-width: 90%;
        max-height: 90vh;
        margin: auto;
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .message-input {
        order: 1;
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: #384756;
        color: white;
    }

    .send-btn {
        padding: 10px 15px;
        background: #0084ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        order: 4;
    }

    .send-btn i {
        font-size: 1.2em;
    }

    .message-avatar img,
    .message-avatar .default-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .message-avatar .default-avatar {
        background-color: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .message {
        display: flex;
        align-items: start;
        margin-bottom: 15px;
        gap: 10px;
    }

    .message-input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #384756;
        padding: 10px;
        border-top: 1px solid #ddd;
        z-index: 100;
        max-width: 800px;
        margin: 0 auto; /* Центрируем контейнер */
        border-radius: 10px;
        box-sizing: border-box;
    }

    @media screen and (max-width: 768px) {
        .message-input-container {
            width: 100%; /* На мобильных занимает всю ширину */
            border-radius: 0;
            padding: 15px;
        }
    }

    .message-audio {
        width: 100%;
        max-width: 300px;
        margin-top: 5px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Кастомные стили для аудио-плеера */
    .message-audio audio {
        width: 100%;
    }

    /* Стили для аудио-плеера в светлой теме (полученные сообщения) */
    .received .message-audio audio::-webkit-media-controls-panel {
        background-color: #f8f9fa;
    }

    .received .message-audio audio::-webkit-media-controls-current-time-display,
    .received .message-audio audio::-webkit-media-controls-time-remaining-display {
        color: #333;
    }

    /* Стили для аудио-плеера в темной теме (отправленные сообщения) */
    .sent .message-audio audio::-webkit-media-controls-panel {
        background-color: #0084ff;
    }

    .sent .message-audio audio::-webkit-media-controls-current-time-display,
    .sent .message-audio audio::-webkit-media-controls-time-remaining-display {
        color: white;
    }

    /* Стили для голосовых сообщений */
    .voice-message {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.1);
    }

    .voice-message-icon {
        font-size: 1.2em;
        color: #0084ff;
    }

    .sent .voice-message-icon {
        color: white;
    }

    .voice-message-duration {
        font-size: 0.8em;
        color: #666;
    }

    .sent .voice-message-duration {
        color: rgba(255, 255, 255, 0.8);
    }

    /* Стили для превью голосового сообщения */
    .voice-preview {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 12px;
        border-radius: 15px;
        color: white;
    }

    .voice-preview i {
        color: #0084ff;
        font-size: 1.2em;
    }

    #replyContainer {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0 10px;
        z-index: 99;
        width: 800px;
        max-width: 100%;
    }

    .reply-preview {
        background-color: #f0f8ff;
        border-left: 4px solid #0084ff;
        padding: 8px 12px;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .reply-content {
        flex-grow: 1;
    }

    .reply-to {
        color: #0084ff;
        font-weight: bold;
        margin-bottom: 4px;
        display: block;
    }

    .reply-text {
        color: #666;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .close-reply {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 0 4px;
    }

    .close-reply:hover {
        color: #333;
    }

    .reply-info {
        font-size: 0.8em;
        color: #0084ff;
        margin-bottom: 4px;
        padding: 4px 8px;
        background-color: rgba(0, 132, 255, 0.1);
        border-radius: 4px;
        cursor: pointer;
    }

    .message.sent .reply-info {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* Стили для контекстного меню */
    .context-menu {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 150px;
    }

    .context-menu-item {
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        color: #333;
    }

    .context-menu-item:hover {
        background: #f0f0f0;
    }

    .context-menu-item i {
        margin-right: 8px;
        width: 16px;
    }

    /* Стили для модального окна редактирования */
    .edit-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1001;
    }

    .edit-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        min-width: 300px;
    }

    .edit-modal textarea {
        width: 100%;
        min-height: 100px;
        margin: 10px 0;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .edit-modal button {
        padding: 8px 16px;
        background: #0084ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .edit-modal .close {
        position: absolute;
        right: 10px;
        top: 10px;
        cursor: pointer;
        font-size: 20px;
    }

    /* Обновляем стили для видео-модального окна */
    .video-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 1000;
    }

    .video-modal-content {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #modalVideo {
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
    }

    /* Стили для превью видео в сообщении */
    .message-video {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        object-fit: contain;
    }

    /* Стили для кнопки закрытия */
    .close-video {
        position: absolute;
        top: -30px;
        right: -30px;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        background: none;
        border: none;
        padding: 5px;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }

    .cancel-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }

    .delete-btn:hover {
        background: #c82333;
    }

    .cancel-btn:hover {
        background: #5a6268;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .user-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .user-details h2 {
        margin: 0;
        font-size: 16px;
        color: #000;
    }
    
    .last-seen {
        font-size: 12px;
        color: #666;
        margin: 0;
    }

    /* Add specific style for highlighted message */
    .message.highlight {
        background-color: rgba(0, 132, 255, 0.1) !important;  /* Light blue background */
        border-radius: 8px;
        padding: 10px;
    }

    .online {
        color: #2ecc71;
    }
    
    .offline {
        color: #95a5a6;
    }

    /* Добавляем новые стили для гамбургер-меню */
    .hamburger-menu {
        display: none;
    }

    .hamburger-menu span {
        display: none;
    }

    .mobile-nav {
        display: none;
    }

    .mobile-nav.active {
        display: none;
    }

    .mobile-nav a {
        display: none;
    }

    .hamburger-menu.active span:nth-child(1) {
        display: none;
    }

    .hamburger-menu.active span:nth-child(2) {
        display: none;
    }

    .hamburger-menu.active span:nth-child(3) {
        display: none;
    }

    @media screen and (max-width: 768px) {
        .hamburger-menu {
            display: none;
        }

        .mobile-nav {
            display: none;
        }

        /* Показываем обычное меню на мобильных */
        .desktop-nav {
            display: block;
        }

        .message-content {
            max-width: 85%;
        }

        .message-image {
            max-width: 100%;
            height: auto;
        }

        .message-attachment {
            width: 100%;
            margin: 5px 0;
        }
    }

    .voice-record-btn {
        background: none;
        border: none;
        color: #0084ff;
        cursor: pointer;
        padding: 10px;
        font-size: 1.2em;
        transition: color 0.2s;
        order: 3;
    }

    .voice-record-btn:hover {
        color: #0056b3;
    }

    .voice-record-btn.recording {
        color: #dc3545;
        animation: pulse 1s infinite;
    }

    .voice-recording-indicator {
        position: absolute;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    @media screen and (max-width: 768px) {
        .voice-recording-indicator {
            bottom: 60px;
        }
    }

    .file-preview-container {
        order: -1;
        width: 100%;
        margin-bottom: 10px;
    }

    .file-preview-container img,
    .file-preview-container video {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
        border-radius: 4px;
    }

    .file-preview-container .file-name {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 12px;
        border-radius: 8px;
        color: white;
    }

    .gallery-link {
        padding: 8px 15px;
        background: #0084ff;
        color: white;
        text-decoration: none;
        border-radius: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background-color 0.2s;
    }

    .gallery-link:hover {
        background: #0056b3;
        color: white;
    }

    @media screen and (max-width: 768px) {
        .gallery-link {
            padding: 6px 12px;
            font-size: 12px;
        }
    }

    /* Стили для поля ввода сообщения */
    .message-input-container {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #2b2b2b;
        border-top: 1px solid #3d3d3d;
        position: sticky;
        bottom: 0;
        width: 100%;
        box-sizing: border-box;
    }

    .message-input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
        background: #383838;
        border-radius: 20px;
        padding: 8px 15px;
    }

    .message-input {
        flex: 1;
        border: none;
        background: transparent;
        color: #fff;
        font-size: 14px;
        padding: 5px;
        min-height: 20px;
        max-height: 100px;
        resize: none;
    }

    .message-input:focus {
        outline: none;
    }

    .attachment-btn,
    .voice-record-btn,
    .send-message-btn {
        background: transparent;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: #0084ff;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .attachment-btn:hover,
    .voice-record-btn:hover,
    .send-message-btn:hover {
        background-color: rgba(0, 132, 255, 0.1);
    }

    .attachment-btn i,
    .voice-record-btn i,
    .send-message-btn i {
        font-size: 20px;
    }

    /* Мобильные стили */
    @media (max-width: 768px) {
        .message-input-container {
            padding: 8px;
            gap: 8px;
        }

        .message-input-wrapper {
            padding: 6px 12px;
        }

        .message-input {
            font-size: 16px; /* Увеличиваем размер шрифта для лучшей читаемости на мобильных */
            padding: 4px;
        }

        .attachment-btn,
        .voice-record-btn,
        .send-message-btn {
            padding: 6px;
        }

        .attachment-btn i,
        .voice-record-btn i,
        .send-message-btn i {
            font-size: 18px;
        }
    }

    /* Стили для iPhone SE и других маленьких экранов */
    @media (max-width: 375px) {
        .message-input-container {
            padding: 6px;
            gap: 6px;
        }

        .message-input-wrapper {
            padding: 4px 10px;
        }

        .attachment-btn,
        .voice-record-btn,
        .send-message-btn {
            padding: 5px;
        }

        .attachment-btn i,
        .voice-record-btn i,
        .send-message-btn i {
            font-size: 16px;
        }
    }
</style>

<div class="chat-container">
    <div class="chat-header">
        {% for user in chat.users.all %}
            {% if user != request.user %}
                <div class="user-info">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="chat-avatar">
                    {% else %}
                        <img src="/static/default_avatar.png" alt="Default Avatar" class="chat-avatar">
                    {% endif %}
                    <div class="user-details">
                        <h2 style="color: #000;">{{ user.profile.name|default:user.username }}</h2>
                        <div class="user-status" data-user-id="{{ user.id }}">
                            {% if user.profile.is_online %}
                                <span id="online-status-{{ user.id }}" class="online">В сети</span>
                            {% else %}
                                <span id="online-status-{{ user.id }}" class="offline">{{ user.profile.get_last_seen }}</span>
                            {% endif %}
                        </div>    
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        
        <!-- Добавляем ссылку на медиагалерею -->
        <a href="{% url 'chat_media_gallery' chat.id %}" class="gallery-link">
            <i class="fas fa-images"></i> Галерея
        </a>
    </div>

    <div class="messages-container">
        {% for message in messages %}
            <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}" 
                 data-message-id="{{ message.id }}">
                <div class="message-avatar">
                    {% if message.sender.profile.avatar %}
                        <img src="{{ message.sender.profile.avatar.url }}" alt="Avatar">
                    {% else %}
                        <div class="default-avatar">{{ message.sender.username|first|upper }}</div>
                    {% endif %}
                </div>
                <div class="message-content">
                    <div class="message-sender">
                        <a href="{% url 'profile_view' message.sender.id %}">
                            {{ message.sender.profile.name|default:message.sender.username }}
                        </a>
                    </div>
                    {% if message.reply_to %}
                        <div class="reply-info" data-reply-id="{{ message.reply_to.id }}">
                            ↪️ {{ message.reply_to.sender.username }}: {{ message.reply_to.content|truncatechars:50 }}
                        </div>
                    {% endif %}
                    <div class="message-text">{{ message.content }}</div>
                    {% if message.attachment %}
    <div class="message-attachment">
        {% if message.attachment.url|lower|slice:"-4:" in '.jpg,.jpeg,.png,.gif,.webp' %}
            <img src="{{ message.attachment.url }}" alt="Attached image" class="message-image">
        {% elif message.attachment.url|lower|slice:"-3:" == 'mp4' or message.attachment.url|lower|slice:"-4:" in '.mov,.webm' %}
            <video src="{{ message.attachment.url }}" class="message-video" preload="metadata" controls></video>
        {% elif message.attachment.url|lower|slice:"-4:" in '.mp3,.ogg,.wav,.webm' %}
            <div class="message-audio">
                <audio controls>
                    <source src="{{ message.attachment.url }}" type="audio/{{ message.attachment.url|lower|slice:"-3:" }}">
                    Ваш браузер не поддерживает аудиоплеер.
                </audio>
            </div>
        {% else %}
            <a href="{{ message.attachment.url }}" target="_blank">
                <i class="fa-solid fa-file"></i> {{ message.attachment.name }}
            </a>
        {% endif %}
    </div>
{% endif %}

                    <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
                </div>
            </div>
        {% empty %}
            <p class="no-messages">Нет сообщений</p>
        {% endfor %}
    </div>
</div>

<!-- Добавьте модальное окно для изображений после chat-container -->
<div id="imageModal" class="modal">
    <img class="modal-content" id="modalImage">
</div>

<!-- Добавляем контекстное меню -->
<div class="context-menu" id="messageContextMenu">
    <div class="context-menu-item reply-message">
        <i class="fas fa-reply"></i>
        <span>Ответить</span>
    </div>
    <div class="context-menu-item edit-message">
        <i class="fas fa-edit"></i>
        <span>Изменить</span>
    </div>
    <div class="context-menu-item delete-message">
        <i class="fas fa-trash"></i>
        <span>Удалить</span>
    </div>
</div>

<!-- Добавляем модальное окно для редактирования -->
<div class="edit-modal" id="editMessageModal">
    <div class="edit-modal-content">
        <span class="close">&times;</span>
        <h2>Редактировать сообщение</h2>
        <form id="editMessageForm">
            <input type="text" id="editMessageText"></input>
            <button type="submit">Сохранить</button>
        </form>
    </div>
</div>

<!-- Обновляем модальное окно для видео -->
<div id="videoModal" class="video-modal">
    <div class="video-modal-content">
        <button class="close-video">&times;</button>
        <video id="modalVideo" controls>
        </video>
    </div>
</div>

<!-- Добавьте модальное окно для подтверждения удаления -->
<div class="edit-modal" id="deleteMessageModal">
    <div class="edit-modal-content">
        <span class="close">&times;</span>
        <h2>Удалить сообщение</h2>
        <p>Вы уверены, что хотите удалить это сообщение?</p>
        <div class="modal-buttons">
            <button id="confirmDelete" class="delete-btn">Удалить</button>
            <button id="cancelDelete" class="cancel-btn">Отмена</button>
        </div>
    </div>
</div>

<div class="message-input-container">
    <div id="replyContainer" style="display: none;">
        <div class="reply-preview">
            <div class="reply-content">
                <small class="reply-to"></small>
                <p class="reply-text"></p>
            </div>
            <button class="close-reply">&times;</button>
        </div>
    </div>
    <form method="post" action="{% url 'send_message' chat.id %}" class="message-form" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="reply_to" id="replyToInput">
        <div class="file-input-container">
            <label for="file-input" class="file-label">
                <i class="fa-solid fa-file"></i>
            </label>
            <input type="file" id="file-input" name="attachment" class="file-input">
            <div class="file-preview-container"></div>
        </div>
        <input type="text" name="content" placeholder="Введите сообщение..." class="message-input">
        <button type="button" class="voice-record-btn">
            <i class="fas fa-microphone"></i>
        </button>
        <button type="submit" class="send-btn">
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>
    <div class="voice-recording-indicator" style="display: none;">
        Идет запись... <span class="recording-time">0:00</span>
    </div>
</div>

<script>
    let lastMessageId = null;

setInterval(function() {
    const messagesContainer = document.querySelector('.messages-container');
    const scrollTop = messagesContainer.scrollTop;
    const scrollHeight = messagesContainer.scrollHeight;
    const clientHeight = messagesContainer.clientHeight;
    const isAtBottom = Math.abs(scrollHeight - clientHeight - scrollTop) < 10;

    fetch('/chat/{{ chat.id }}/messages/')
        .then(response => response.json())
        .then(data => {
            // Check if there are new messages
            if (data.last_message_id !== lastMessageId) {
                // Update last message ID
                lastMessageId = data.last_message_id;

                // Update messages container
                messagesContainer.innerHTML = data.messages_html;

                // Check for reply context
                const replyingToId = localStorage.getItem('replyingToId');
                if (replyingToId) {
                    scrollToMessage(replyingToId);
                    localStorage.removeItem('replyingToId');
                } else {
                    // Scroll behavior
                    if (isAtBottom) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    } else {
                        messagesContainer.scrollTop = scrollTop;
                    }
                }

                // Reinitialize image handlers
                const images = messagesContainer.querySelectorAll('.message-image');
                images.forEach(image => {
                    image.addEventListener('click', function(e) {
                        const modal = document.getElementById('imageModal');
                        const modalImg = document.getElementById('modalImage');
                        const messageInputContainer = document.querySelector('.message-input-container');
                        modal.style.display = "block";
                        modalImg.src = e.target.src;
                        messageInputContainer.style.display = "none";
                    });
                });
            }
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
        });
}, 3000);

    // Вспомогательные функции
    function isUserAtBottom() {
        const messagesContainer = document.querySelector('.messages-container');
        return Math.abs(messagesContainer.scrollHeight - messagesContainer.clientHeight - messagesContainer.scrollTop) < 10;
    }

    function scrollToBottom() {
        const messagesContainer = document.querySelector('.messages-container');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function initializeMessageHandlers(messageElement) {
        // Инициализация обработчиков для изображений
        const images = messageElement.querySelectorAll('.message-image');
        images.forEach(image => {
            image.addEventListener('click', function(e) {
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                const messageInputContainer = document.querySelector('.message-input-container');
                modal.style.display = "block";
                modalImg.src = e.target.src;
                messageInputContainer.style.display = "none";
            });
        });

        // Инициализация обработчиков для видео
        const videos = messageElement.querySelectorAll('.message-video');
        videos.forEach(video => {
            video.addEventListener('click', function(e) {
                const videoModal = document.getElementById('videoModal');
                const modalVideo = document.getElementById('modalVideo');
                const messageInputContainer = document.querySelector('.message-input-container');
                videoModal.style.display = "flex";
                modalVideo.src = e.target.src;
                messageInputContainer.style.display = "none";
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.querySelector('.message-input');
        const messageForm = document.querySelector('.message-form');
        const contextMenu = document.getElementById('messageContextMenu');
        const editModal = document.getElementById('editMessageModal');
        let currentMessageId = null;

        const savedMessage = localStorage.getItem('savedMessage');
        if (savedMessage) {
            messageInput.value = savedMessage;
        }

        messageInput.addEventListener('input', function() {
            localStorage.setItem('savedMessage', messageInput.value);
        });

        const sendButton = document.querySelector('.send-btn');

        // Add touch event listener for mobile
        sendButton.addEventListener('touchstart', function(e) {
            e.preventDefault(); // Prevent default behavior
            messageForm.dispatchEvent(new Event('submit')); // Trigger form submission
        });

        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(() => {
                // Clear the input fields and reply preview
                this.querySelector('.message-input').value = '';
                this.querySelector('#file-input').value = '';
                this.querySelector('.file-preview-container').innerHTML = '';
                replyContainer.style.display = 'none';
                replyToInput.value = '';
                
                // Refresh messages
                fetch('/chat/{{ chat.id }}/messages/')
                    .then(response => response.json())
                    .then(data => {
                        document.querySelector('.messages-container').innerHTML = data.messages_html;
                    });
            });
        });

        document.addEventListener('click', function(e) {
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });

        document.querySelector('.edit-modal .close').addEventListener('click', function() {
            editModal.style.display = 'none';
        });

        document.querySelector('.delete-message').addEventListener('click', function() {
            const deleteModal = document.getElementById('deleteMessageModal');
            deleteModal.style.display = 'block';
            contextMenu.style.display = 'none';
        });

        document.getElementById('cancelDelete').addEventListener('click', function() {
            document.getElementById('deleteMessageModal').style.display = 'none';
        });

        document.getElementById('confirmDelete').addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default behavior
            handleDeleteConfirmation();
        });

        document.getElementById('confirmDelete').addEventListener('touchstart', function(e) {
            e.preventDefault(); // Prevent default behavior
            handleDeleteConfirmation();
        });

        function handleDeleteConfirmation() {
            fetch(`/message/${currentMessageId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(response => {
                if (response.ok) {
                    document.getElementById('deleteMessageModal').style.display = 'none';
                    location.reload();
                }
            });
        }

        document.querySelector('.edit-message').addEventListener('click', function() {
            const messageElement = document.querySelector(`[data-message-id="${currentMessageId}"]`);
            const messageText = messageElement.querySelector('.message-text').textContent;
            
            document.getElementById('editMessageText').value = messageText;
            editModal.style.display = 'block';
            contextMenu.style.display = 'none';
        });

        document.getElementById('editMessageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newText = document.getElementById('editMessageText').value;

            fetch(`/message/${currentMessageId}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    content: newText
                })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let touchTimeout;
        let isLongPress = false;

        // Обработчик для десктопа
        document.addEventListener('contextmenu', function(e) {
            const messageElement = e.target.closest('.message');
            if (messageElement) {
                e.preventDefault();
                showContextMenu(e, messageElement);
            }
        });

        // Обработчики для мобильных устройств
        document.addEventListener('touchstart', function(e) {
            const messageElement = e.target.closest('.message');
            if (messageElement) {
                isLongPress = false;
                touchTimeout = setTimeout(() => {
                    isLongPress = true;
                    showContextMenu(e, messageElement);
                }, 400); // 1 секунда задержки
            }
        });

        document.addEventListener('touchend', function(e) {
            clearTimeout(touchTimeout);
            if (isLongPress) {
                e.preventDefault(); // Предотвращаем клик после долгого нажатия
            }
        });

        document.addEventListener('touchmove', function(e) {
            clearTimeout(touchTimeout); // Отменяем таймер при движении пальца
        });

        // Функция для показа контекстного меню
        function showContextMenu(e, messageElement) {
            currentMessageId = messageElement.dataset.messageId;
            contextMenu.style.display = 'block';
            
            // Получаем координаты
            let x, y;
            if (e.type.startsWith('touch')) {
                const touch = e.touches[0] || e.changedTouches[0];
                x = touch.pageX;
                y = touch.pageY;
            } else {
                x = e.pageX;
                y = e.pageY;
            }
            
            const menuWidth = contextMenu.offsetWidth;
            const menuHeight = contextMenu.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // Корректируем позицию меню, чтобы оно не выходило за пределы экрана
            if (x + menuWidth > windowWidth) {
                x = windowWidth - menuWidth;
            }
            if (y + menuHeight > windowHeight) {
                y = windowHeight - menuHeight;
            }
            
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';

            // Показываем/скрываем пункты меню в зависимости от того, чье сообщение
            const isOwnMessage = messageElement.classList.contains('sent');
            document.querySelector('.edit-message').style.display = isOwnMessage ? 'flex' : 'none';
            document.querySelector('.delete-message').style.display = isOwnMessage ? 'flex' : 'none';
        }

        // Обработчики для кнопок в контекстном меню
        document.querySelector('.reply-message').addEventListener('touchstart', function(e) {
            e.preventDefault(); // Предотвращаем стандартное поведение
            handleReplyMessage();
        });

        document.querySelector('.edit-message').addEventListener('touchstart', function(e) {
            e.preventDefault();
            handleEditMessage();
        });

        document.querySelector('.delete-message').addEventListener('touchstart', function(e) {
            e.preventDefault();
            handleDeleteMessage();
        });

        // Также сохраняем обработчики для клика (десктоп)
        document.querySelector('.reply-message').addEventListener('click', handleReplyMessage);
        document.querySelector('.edit-message').addEventListener('click', handleEditMessage);
        document.querySelector('.delete-message').addEventListener('click', handleDeleteMessage);

        // Выносим логику в отдельные функции
        function handleReplyMessage() {
            const messageElement = document.querySelector(`[data-message-id="${currentMessageId}"]`);
            const messageText = messageElement.querySelector('.message-text').textContent;
            const senderName = messageElement.querySelector('.message-sender').textContent.trim();

            replyingToId = currentMessageId;
            replyToInput.value = currentMessageId;
            replyContainer.style.display = 'block';
            
            const replyPreview = replyContainer.querySelector('.reply-preview');
            replyPreview.querySelector('.reply-to').textContent = `В ответ ${senderName}`;
            replyPreview.querySelector('.reply-text').textContent = messageText;

            contextMenu.style.display = 'none';
            document.querySelector('.message-input').focus();
        }

        function handleEditMessage() {
            const messageElement = document.querySelector(`[data-message-id="${currentMessageId}"]`);
            const messageText = messageElement.querySelector('.message-text').textContent;

            document.getElementById('editMessageText').value = messageText;
            editModal.style.display = 'block';
            contextMenu.style.display = 'none';
        }

        function handleDeleteMessage() {
            const deleteModal = document.getElementById('deleteMessageModal');
            deleteModal.style.display = 'block';
            contextMenu.style.display = 'none';
        }

        // Обновляем обработчики для видео
        const videoModal = document.getElementById('videoModal');
        const modalVideo = document.getElementById('modalVideo');
        const messageInputContainer = document.querySelector('.message-input-container');
        const closeVideoBtn = document.querySelector('.close-video');

        // Функция закрытия модального окна с видео
        function closeVideoModal() {
            videoModal.style.display = "none";
            messageInputContainer.style.display = "block";
            modalVideo.pause();
            modalVideo.currentTime = 0;
            modalVideo.src = '';
        }

        // Обработчик клавиши Escape для всех модальных окон
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeVideoModal();
                imageModal.style.display = "none";
                messageInputContainer.style.display = "block";
            }
        });

        // Обработчик для открытия видео
        document.querySelector('.messages-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('message-video')) {
                e.preventDefault();
                videoModal.style.display = "flex";
                modalVideo.src = e.target.src;
                messageInputContainer.style.display = "none";
            }
        });

        // Закрытие видео по клику на крестик или фон
        videoModal.addEventListener('click', function(e) {
            if (e.target === videoModal || e.target === closeVideoBtn) {
                closeVideoModal();
            }
        });

        // Обновляем обработчики для изображений
        const imageModal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const imageCache = new Map(); // Кэш для изображений

        // Предварительная загрузка изображений
        function preloadImage(src) {
            if (!imageCache.has(src)) {
                const img = new Image();
                img.src = src;
                imageCache.set(src, img);
            }
            return imageCache.get(src);
        }

        // Закрытие изображения по клику в любое место
        imageModal.addEventListener('click', function(e) {
            imageModal.style.display = "none";
            messageInputContainer.style.display = "block";
        });

        // Обработчики для изображений в сообщениях
        document.querySelector('.messages-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('message-image')) {
                e.preventDefault();
                const imgSrc = e.target.src;
                modalImg.src = imgSrc;
                imageModal.style.display = "block";
                messageInputContainer.style.display = "none";
            }
        });

        // Инициализация предварительной загрузки всех изображений при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.message-image').forEach(img => {
                preloadImage(img.src);
            });
        });

        let replyingToId = null;
        const replyContainer = document.getElementById('replyContainer');
        const replyToInput = document.getElementById('replyToInput');

        // Добавляем обработчик для кнопки "Ответить"
        document.querySelector('.reply-message').addEventListener('click', function() {
            const messageElement = document.querySelector(`[data-message-id="${currentMessageId}"]`);
            const messageText = messageElement.querySelector('.message-text').textContent;
            const senderName = messageElement.querySelector('.message-sender').textContent.trim();

            replyingToId = currentMessageId;
            replyToInput.value = currentMessageId;
            replyContainer.style.display = 'block';
            
            const replyPreview = replyContainer.querySelector('.reply-preview');
            replyPreview.querySelector('.reply-to').textContent = `В ответ ${senderName}`;
            replyPreview.querySelector('.reply-text').textContent = messageText;
            
            contextMenu.style.display = 'none';
            document.querySelector('.message-input').focus();
        });

        // Обработчик для закрытия превью ответа
        const closeReplyBtn = document.querySelector('.close-reply');
        closeReplyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            replyContainer.style.display = 'none';
            replyToInput.value = '';
            replyingToId = null;
        });

        // Обработчик для клика по информации об ответе
        document.querySelector('.messages-container').addEventListener('click', function(e) {
            if (e.target.classList.contains('reply-info')) {
                const replyId = e.target.dataset.replyId;
                const replyMessage = document.querySelector(`[data-message-id="${replyId}"]`);
                if (replyMessage) {
                    replyMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    replyMessage.classList.add('highlight');
                    setTimeout(() => {
                        replyMessage.classList.remove('highlight');
                    }, 2000);
                }
            }
        });

        // Добавляем обработчик для отображения имени файла
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.querySelector('.file-preview-container');
        
        fileInput.addEventListener('change', function() {
            previewContainer.innerHTML = ''; // Clear previous preview
            
            if (this.files.length > 0) {
                const file = this.files[0];
                
                if (file.type.startsWith('image/')) {
                    // Handle image files
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    previewContainer.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    // Handle video files
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.controls = true;
                    previewContainer.appendChild(video);
                } else {
                    // Handle other file types
                    const fileName = document.createElement('div');
                    fileName.className = 'file-name';
                    fileName.textContent = file.name;
                    previewContainer.appendChild(fileName);
                }
            }
        });

        // Clean up object URLs when form is submitted
        document.querySelector('.message-form').addEventListener('submit', function() {
            const preview = previewContainer.querySelector('img, video');
            if (preview) {
                URL.revokeObjectURL(preview.src);
            }
            previewContainer.innerHTML = '';
        });

        function updateOnlineStatus() {
            const statusElements = document.querySelectorAll('.user-status');
            
            statusElements.forEach(element => {
                const userId = element.dataset.userId;
                fetch(`/get_user_status/${userId}/`)
                    .then(response => response.json())
                    .then(data => {
                        const statusSpan = document.getElementById(`online-status-${userId}`);
                        if (statusSpan) {
                            statusSpan.textContent = data.status;
                            statusSpan.className = data.is_online ? 'online' : 'offline';
                        }
                    });
            });
        }

        // Обновляем статус каждые 10 секунд
        setInterval(updateOnlineStatus, 10000);

        // Также обновляем статус при загрузке страницы
        document.addEventListener('DOMContentLoaded', updateOnlineStatus);

        // Обработчики для кнопки отмены удаления
        document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
        document.getElementById('cancelDelete').addEventListener('touchstart', function(e) {
            e.preventDefault();
            closeDeleteModal();
        });

        // Обработчики для крестика в модальном окне удаления
        document.querySelector('#deleteMessageModal .close').addEventListener('click', closeDeleteModal);
        document.querySelector('#deleteMessageModal .close').addEventListener('touchstart', function(e) {
            e.preventDefault();
            closeDeleteModal();
        });

        // Обработчики для крестика в модальном окне редактирования
        document.querySelector('#editMessageModal .close').addEventListener('click', closeEditModal);
        document.querySelector('#editMessageModal .close').addEventListener('touchstart', function(e) {
            e.preventDefault();
            closeEditModal();
        });

        // Обработчики для крестика в превью ответа
        document.querySelector('.close-reply').addEventListener('click', closeReplyPreview);
        document.querySelector('.close-reply').addEventListener('touchstart', function(e) {
            e.preventDefault();
            closeReplyPreview();
        });

        // Функции закрытия модальных окон
        function closeDeleteModal() {
            document.getElementById('deleteMessageModal').style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('editMessageModal').style.display = 'none';
        }

        function closeReplyPreview() {
            document.getElementById('replyContainer').style.display = 'none';
            document.getElementById('replyToInput').value = '';
            replyingToId = null;
        }

        // Добавляем обработчики для записи голосовых сообщений
        const voiceButton = document.querySelector('.voice-record-btn');
        const recordingIndicator = document.querySelector('.voice-recording-indicator');
        const recordingTime = document.querySelector('.recording-time');
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingTimer = null;

        // Функция для форматирования времени
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = seconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Функция обновления таймера
        function updateRecordingTime() {
            const seconds = Math.floor((Date.now() - recordingStartTime) / 1000);
            recordingTime.textContent = formatTime(seconds);
        }

        // Функция начала записи
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Создаем File объект из Blob
                    const audioFile = new File([audioBlob], 'voice-message.webm', { type: 'audio/webm' });
                    
                    // Создаем новый FileList-подобный объект
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(audioFile);
                    
                    // Устанавливаем файл в input file
                    const fileInput = document.querySelector('.file-input');
                    fileInput.files = dataTransfer.files;
                    
                    // Показываем превью голосового сообщения в контейнере
                    const previewContainer = document.querySelector('.file-preview-container');
                    previewContainer.innerHTML = `
                        <div class="voice-preview">
                            <i class="fas fa-microphone"></i>
                            <span>Голосовое сообщение</span>
                        </div>
                    `;
                    
                    // Останавливаем все треки
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                voiceButton.classList.add('recording');
                recordingIndicator.style.display = 'block';
                recordingStartTime = Date.now();
                recordingTimer = setInterval(updateRecordingTime, 1000);

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Не удалось получить доступ к микрофону');
            }
        }

        // Функция остановки записи
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                voiceButton.classList.remove('recording');
                recordingIndicator.style.display = 'none';
                clearInterval(recordingTimer);
            }
        }

        // Обработчики для компьютера
        voiceButton.addEventListener('mousedown', startRecording);
        document.addEventListener('mouseup', stopRecording);

        // Обработчики для мобильных устройств
        voiceButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startRecording();
        });
        
        voiceButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRecording();
        });

        // Отменяем запись при уходе со страницы
        window.addEventListener('beforeunload', stopRecording);

        // Получаем параметры URL
        const urlParams = new URLSearchParams(window.location.search);
        const messageId = urlParams.get('message_id');
        const shouldHighlight = urlParams.get('highlight');

        if (messageId && shouldHighlight) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                // Прокручиваем к сообщению
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Добавляем подсветку
                messageElement.classList.add('highlight');
                
                // Убираем подсветку через 2 секунды
                setTimeout(() => {
                    messageElement.classList.remove('highlight');
                }, 2000);
            }
        }
    });
</script>
{% endblock %} 